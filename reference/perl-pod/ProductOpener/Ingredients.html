<html><head><title>ProductOpener::Ingredients</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="simple.min" type="text/css" href="../simple.min.css" media="all" >

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Tue Jan 10 18:00:10 2023 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#init_allergens_regexps_()_-_initialize_regular_expressions_needed_for_ingredients_parsing'>init_allergens_regexps () - initialize regular expressions needed for ingredients parsing</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#init_labels_regexps_()_-_initialize_regular_expressions_needed_for_ingredients_parsing'>init_labels_regexps () - initialize regular expressions needed for ingredients parsing</a>
    <li class='indexItem indexItem2'><a href='#has_specific_ingredient_property_(_product_ref%2C_searched_ingredient_id%2C_property_)'>has_specific_ingredient_property ( product_ref, searched_ingredient_id, property )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#product_ref'>product_ref</a>
        <li class='indexItem indexItem4'><a href='#searched_ingredient_id'>searched_ingredient_id</a>
        <li class='indexItem indexItem4'><a href='#property'>property</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#value'>value</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#add_properties_from_specific_ingredients_(_product_ref_)'>add_properties_from_specific_ingredients ( product_ref )</a>
    <li class='indexItem indexItem2'><a href='#add_specific_ingredients_from_labels_(_product_ref_)'>add_specific_ingredients_from_labels ( product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#specific_ingredients_structure'>specific_ingredients structure</a>
        <li class='indexItem indexItem4'><a href='#_'></a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#parse_specific_ingredients_from_text_(_product_ref%2C_%24text%2C_%24percent_regexp_)'>parse_specific_ingredients_from_text ( product_ref, $text, $percent_regexp )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#product_ref'>product_ref</a>
        <li class='indexItem indexItem4'><a href='#text_%24text'>text $text</a>
        <li class='indexItem indexItem4'><a href='#percent_regular_expression_%24percent_regexp'>percent regular expression $percent_regexp</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#specific_ingredients_structure'>specific_ingredients structure</a>
        <li class='indexItem indexItem4'><a href='#_'></a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#parse_origins_from_text_(_product_ref%2C_%24text)'>parse_origins_from_text ( product_ref, $text)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#product_ref'>product_ref</a>
        <li class='indexItem indexItem4'><a href='#text_%24text'>text $text</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#specific_ingredients_structure'>specific_ingredients structure</a>
        <li class='indexItem indexItem4'><a href='#_'></a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#parse_ingredients_text_(_product_ref_)'>parse_ingredients_text ( product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#ingredients_structure'>ingredients structure</a>
        <li class='indexItem indexItem4'><a href='#_'></a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#flatten_sub_ingredients_(_product_ref_)'>flatten_sub_ingredients ( product_ref )</a>
    <li class='indexItem indexItem2'><a href='#compute_ingredients_tags_(_product_ref_)'>compute_ingredients_tags ( product_ref )</a>
    <li class='indexItem indexItem2'><a href='#extract_ingredients_from_text_(_product_ref_)'>extract_ingredients_from_text ( product_ref )</a>
    <li class='indexItem indexItem2'><a href='#delete_ingredients_percent_values_(_ingredients_ref_)'>delete_ingredients_percent_values ( ingredients_ref )</a>
    <li class='indexItem indexItem2'><a href='#compute_ingredients_percent_values_(_total_min%2C_total_max%2C_ingredients_ref_)'>compute_ingredients_percent_values ( total_min, total_max, ingredients_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#total_min_-_the_minimum_percent_value_of_the_total_of_all_the_ingredients_in_ingredients_ref'>total_min - the minimum percent value of the total of all the ingredients in ingredients_ref</a>
        <li class='indexItem indexItem4'><a href='#total_max_-_the_maximum_percent_value_of_all_ingredients_passed_in_ingredients_ref'>total_max - the maximum percent value of all ingredients passed in ingredients_ref</a>
        <li class='indexItem indexItem4'><a href='#ingredient_ref_%3A_nested_array_of_ingredients_and_sub-ingredients'>ingredient_ref : nested array of ingredients and sub-ingredients</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Negative_value_-_analysis_error'>Negative value - analysis error</a>
        <li class='indexItem indexItem4'><a href='#0_or_positive_value_-_analysis_ok'>0 or positive value - analysis ok</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#init_percent_values(%24total_min%2C_%24total_max%2C_%24ingredients_ref)'>init_percent_values($total_min, $total_max, $ingredients_ref)</a>
    <li class='indexItem indexItem2'><a href='#set_percent_max_from_taxonomy_(_ingredients_ref_)'>set_percent_max_from_taxonomy ( ingredients_ref )</a>
    <li class='indexItem indexItem2'><a href='#compute_ingredients_percent_estimates_(_total%2C_ingredients_ref_)'>compute_ingredients_percent_estimates ( total, ingredients_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#total_-_the_total_of_all_the_ingredients_in_ingredients_ref'>total - the total of all the ingredients in ingredients_ref</a>
        <li class='indexItem indexItem4'><a href='#ingredient_ref_%3A_nested_array_of_ingredients_and_sub-ingredients'>ingredient_ref : nested array of ingredients and sub-ingredients</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#analyze_ingredients_(_product_ref_)'>analyze_ingredients ( product_ref )</a>
    <li class='indexItem indexItem2'><a href='#validate_regular_expressions_(_)'>validate_regular_expressions ( )</a>
    <li class='indexItem indexItem2'><a href='#split_generic_name_from_ingredients_(_product_ref_language_code_)'>split_generic_name_from_ingredients ( product_ref language_code )</a>
    <li class='indexItem indexItem2'><a href='#clean_ingredients_text_for_lang_(_product_ref_language_code_)'>clean_ingredients_text_for_lang ( product_ref language_code )</a>
    <li class='indexItem indexItem2'><a href='#cut_ingredients_text_for_lang_(_product_ref_language_code_)'>cut_ingredients_text_for_lang ( product_ref language_code )</a>
    <li class='indexItem indexItem2'><a href='#replace_additive_(%24number%2C_%24letter%2C_%24variant)_-_normalize_the_additive'>replace_additive ($number, $letter, $variant) - normalize the additive</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Synopsis'>Synopsis</a>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Language'>Language</a>
        <li class='indexItem indexItem4'><a href='#Ingredients_list_text'>Ingredients list text</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_value'>Return value</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Transformed_ingredients_list_text'>Transformed ingredients list text</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#preparse_ingredients_text_(%24product_lc%2C_%24text)_-_normalize_the_ingredient_list_to_make_parsing_easier'>preparse_ingredients_text ($product_lc, $text) - normalize the ingredient list to make parsing easier</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Language'>Language</a>
        <li class='indexItem indexItem4'><a href='#Ingredients_list_text'>Ingredients list text</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_value'>Return value</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Transformed_ingredients_list_text'>Transformed ingredients list text</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#detect_allergens_from_ingredients_(_%24product_ref_)'>detect_allergens_from_ingredients ( $product_ref )</a>
    <li class='indexItem indexItem2'><a href='#detect_allergens_from_text_(_%24product_ref_)'>detect_allergens_from_text ( $product_ref )</a>
    <li class='indexItem indexItem2'><a href='#add_fruits_(_%24ingredients_ref_)'>add_fruits ( $ingredients_ref )</a>
    <li class='indexItem indexItem2'><a href='#estimate_nutriscore_fruits_vegetables_nuts_value_from_ingredients_(_product_ref_)'>estimate_nutriscore_fruits_vegetables_nuts_value_from_ingredients ( product_ref )</a>
    <li class='indexItem indexItem2'><a href='#add_milk_(_%24ingredients_ref_)'>add_milk ( $ingredients_ref )</a>
    <li class='indexItem indexItem2'><a href='#estimate_milk_percent_from_ingredients_(_product_ref_)'>estimate_milk_percent_from_ingredients ( product_ref )</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#POD_ERRORS'>POD ERRORS</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>ProductOpener::Ingredients - process and analyze ingredients lists</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<p><code>ProductOpener::Ingredients</code> processes,
normalize,
parses and analyze ingredients lists to extract and recognize individual ingredients,
additives and allergens,
and to compute product properties related to ingredients (is the product vegetarian,
vegan,
does it contain palm oil etc.)</p>

<pre>    use ProductOpener::Ingredients qw/:all/;

        [..]

        clean_ingredients_text($product_ref);

        extract_ingredients_from_text($product_ref);

        extract_ingredients_classes_from_text($product_ref);

        detect_allergens_from_text($product_ref);</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>[..]</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="init_allergens_regexps_()_-_initialize_regular_expressions_needed_for_ingredients_parsing"
>init_allergens_regexps () - initialize regular expressions needed for ingredients parsing</a></h2>

<p>This function initializes regular expressions needed to parse traces and allergens in ingredients lists.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="init_labels_regexps_()_-_initialize_regular_expressions_needed_for_ingredients_parsing"
>init_labels_regexps () - initialize regular expressions needed for ingredients parsing</a></h2>

<p>This function creates regular expressions that match all variations of labels that we want to recognize in ingredients lists, such as organic and fair trade.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="has_specific_ingredient_property_(_product_ref,_searched_ingredient_id,_property_)"
>has_specific_ingredient_property ( product_ref, searched_ingredient_id, property )</a></h2>

<p>Check if the specific ingredients structure (extracted from the end of the ingredients list and product labels) contains a property for an ingredient. (e.g. do we have an origin specified for a specific ingredient)</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="product_ref"
>product_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="searched_ingredient_id"
>searched_ingredient_id</a></h4>

<p>If the ingredient_id parameter is undef, then we return the value for any specific ingredient. (useful for products for which we do not have ingredients, but for which we have a label like &#34;French eggs&#34;: we can still derive the origin of the ingredients, e.g. for the Eco-Score)</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="property"
>property</a></h4>

<p>e.g. &#34;origins&#34;</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="value"
>value</a></h4>

<p>- undef if we don&#39;t have a specific ingredient with the requested property matching the requested ingredient - otherwise the value for the matching specific ingredient</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_properties_from_specific_ingredients_(_product_ref_)"
>add_properties_from_specific_ingredients ( product_ref )</a></h2>

<p>Go through the ingredients structure, and ad properties to ingredients that match specific ingredients for which we have extra information (e.g. origins from a label).</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_specific_ingredients_from_labels_(_product_ref_)"
>add_specific_ingredients_from_labels ( product_ref )</a></h2>

<p>Check if the product has labels that indicate properties (e.g. origins) for specific ingredients.</p>

<p>e.g.</p>

<p>en:French pork fr:Viande Porcine Fran&#231;aise, VPF, viande de porc fran&#231;aise, Le Porc Fran&#231;ais, Porc Origine France, porc fran&#231;ais, porc 100% France origins:en: en:france ingredients:en: en:pork</p>

<p>This function extracts those mentions and adds them to the specific_ingredients structure.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="specific_ingredients_structure"
>specific_ingredients structure</a></h4>

<p>Array of specific ingredients.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="_"
></a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="parse_specific_ingredients_from_text_(_product_ref,_$text,_$percent_regexp_)"
>parse_specific_ingredients_from_text ( product_ref, $text, $percent_regexp )</a></h2>

<p>Lists of ingredients sometime include extra mentions for specific ingredients at the end of the ingredients list. e.g. &#34;Prepared with 50g of fruits for 100g of finished product&#34;.</p>

<p>This function extracts those mentions and adds them to the specific_ingredients structure.</p>

<p>This function is also used to parse the origins of ingredients field.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="product_ref"
>product_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="text_$text"
>text $text</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="percent_regular_expression_$percent_regexp"
>percent regular expression $percent_regexp</a></h4>

<p>Used to find % values, language specific.</p>

<p>Pass undef in order to skip % recognition. This is useful if we know the text is only for the origins of ingredients.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="specific_ingredients_structure"
>specific_ingredients structure</a></h4>

<p>Array of specific ingredients.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="_"
></a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="parse_origins_from_text_(_product_ref,_$text)"
>parse_origins_from_text ( product_ref, $text)</a></h2>

<p>This function parses the origins of ingredients field to extract the origins of specific ingredients. The origins are stored in the specific_ingredients structure of the product.</p>

<p>Note: this function is similar to parse_specific_ingredients_from_text() that operates on ingredients lists. The difference is that parse_specific_ingredients_from_text() only extracts and recognizes text that is an extra mention at the end of an ingredient list (e.g. &#34;Origin of strawberries: Spain&#34;), while parse_origins_from_text() will also recognize text like &#34;Strawberries: Spain&#34;.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="product_ref"
>product_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="text_$text"
>text $text</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="specific_ingredients_structure"
>specific_ingredients structure</a></h4>

<p>Array of specific ingredients.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="_"
></a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="parse_ingredients_text_(_product_ref_)"
>parse_ingredients_text ( product_ref )</a></h2>

<p>Parse the ingredients_text field to extract individual ingredients.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="ingredients_structure"
>ingredients structure</a></h4>

<p>Nested structure of ingredients and sub-ingredients</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="_"
></a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="flatten_sub_ingredients_(_product_ref_)"
>flatten_sub_ingredients ( product_ref )</a></h2>

<p>Flatten the nested list of ingredients.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_ingredients_tags_(_product_ref_)"
>compute_ingredients_tags ( product_ref )</a></h2>

<p>Go through the nested ingredients and:</p>

<p>Compute ingredients_original_tags and ingredients_tags.</p>

<p>Compute the total % of &#34;leaf&#34; ingredients (without sub-ingredients) with a specified %, and unspecified %.</p>

<p>- ingredients_with_specified_percent_n : number of &#34;leaf&#34; ingredients with a specified % - ingredients_with_specified_percent_sum : % sum of &#34;leaf&#34; ingredients with a specified % - ingredients_with_unspecified_percent_n - ingredients_with_unspecified_percent_sum</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="extract_ingredients_from_text_(_product_ref_)"
>extract_ingredients_from_text ( product_ref )</a></h2>

<p>This function calls:</p>

<p>- parse_ingredients_text() to parse the ingredients text in the main language of the product to extract individual ingredients and sub-ingredients</p>

<p>- compute_ingredients_percent_values() to create the ingredients array with nested sub-ingredients arrays</p>

<p>- compute_ingredients_tags() to create a flat array ingredients_original_tags and ingredients_tags (with parents)</p>

<p>- analyze_ingredients() to analyze ingredients to see the ones that are vegan, vegetarian, from palm oil etc. and to compute the resulting value for the complete product</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="delete_ingredients_percent_values_(_ingredients_ref_)"
>delete_ingredients_percent_values ( ingredients_ref )</a></h2>

<p>This function deletes the percent_min and percent_max values of all ingredients.</p>

<p>It is called if the compute_ingredients_percent_values() encountered impossible values (e.g. &#34;Water, Sugar 80%&#34; -&#62; Water % should be greater than 80%, but the total would be more than 100%)</p>

<p>The function is recursive to also delete values for sub-ingredients.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_ingredients_percent_values_(_total_min,_total_max,_ingredients_ref_)"
>compute_ingredients_percent_values ( total_min, total_max, ingredients_ref )</a></h2>

<p>This function computes the possible minimum and maximum ranges for the percent values of each ingredient and sub-ingredients.</p>

<p>Ingredients lists sometimes specify the percent value for some ingredients, but usually not all. This functions computes minimum and maximum percent values for all other ingredients.</p>

<p>Ingredients list are ordered by descending order of quantity.</p>

<p>This function is recursive and it calls itself for each ingredients with sub-ingredients.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="total_min_-_the_minimum_percent_value_of_the_total_of_all_the_ingredients_in_ingredients_ref"
>total_min - the minimum percent value of the total of all the ingredients in ingredients_ref</a></h4>

<p>0 when the function is called on all ingredients of a product, but can be different than 0 if called on sub-ingredients of an ingredient that has a minimum value set.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="total_max_-_the_maximum_percent_value_of_all_ingredients_passed_in_ingredients_ref"
>total_max - the maximum percent value of all ingredients passed in ingredients_ref</a></h4>

<p>100 when the function is called on all ingredients of a product, but can be different than 0 if called on sub-ingredients of an ingredient that has a maximum value set.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="ingredient_ref_:_nested_array_of_ingredients_and_sub-ingredients"
>ingredient_ref : nested array of ingredients and sub-ingredients</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Negative_value_-_analysis_error"
>Negative value - analysis error</a></h4>

<p>The analysis encountered an impossible value. e.g. &#34;Flour, Sugar 80%&#34;: The % of Flour must be greated to the % of Sugar, but the sum would then be above 100%.</p>

<p>Or there were too many loops to analyze the values.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="0_or_positive_value_-_analysis_ok"
>0 or positive value - analysis ok</a></h4>

<p>The return value is the number of times we adjusted min and max values for ingredients and sub ingredients.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="init_percent_values($total_min,_$total_max,_$ingredients_ref)"
>init_percent_values($total_min, $total_max, $ingredients_ref)</a></h2>

<p>Initialize the percent, percent_min and percent_max value for each ingredient in list.</p>

<p>$ingredients_ref is the list of ingredients (as hash), where parsed percent are already set.</p>

<p>$total_min and $total_max might be set if we have a parent ingredient and are parsing a sub list.</p>

<p>When a percent is specifically set, use this value for percent_min and percent_max.</p>

<p>Warning: percent listed for sub-ingredients can be absolute (e.g. &#34;Sugar, fruits 40% (pear 30%, apple 10%)&#34;) or they can be relative to the parent ingredient (e.g. &#34;Sugar, fruits 40% (pear 75%, apple 25%)&#34;. We try to detect those cases and rescale the percent accordingly.</p>

<p>Otherwise use 0 for percent_min and total_max for percent_max.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="set_percent_max_from_taxonomy_(_ingredients_ref_)"
>set_percent_max_from_taxonomy ( ingredients_ref )</a></h2>

<p>Set the percentage maximum for ingredients like flavouring where this is defined on the Ingredients taxonomy. The percent_max will not be applied in the following cases:</p>

<pre> - if applying the percent_max would mean that it is not possible for the ingredient
   total to add up to 100%
 - If a later ingredient has a higher percentage than the percent_max of the restricted ingredient</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_ingredients_percent_estimates_(_total,_ingredients_ref_)"
>compute_ingredients_percent_estimates ( total, ingredients_ref )</a></h2>

<p>This function computes a possible estimate for the percent values of each ingredient and sub-ingredients.</p>

<p>The sum of all estimates must be 100%, and the estimates try to match the min and max constraints computed previously with the compute_ingredients_percent_values() function.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="total_-_the_total_of_all_the_ingredients_in_ingredients_ref"
>total - the total of all the ingredients in ingredients_ref</a></h4>

<p>100 when the function is called on all ingredients of a product, but can be different than 100 if called on sub-ingredients of an ingredient.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="ingredient_ref_:_nested_array_of_ingredients_and_sub-ingredients"
>ingredient_ref : nested array of ingredients and sub-ingredients</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="analyze_ingredients_(_product_ref_)"
>analyze_ingredients ( product_ref )</a></h2>

<p>This function analyzes ingredients to see the ones that are vegan, vegetarian, from palm oil etc. and computes the resulting value for the complete product.</p>

<p>The results are overrode by labels like &#34;Vegan&#34;, &#34;Vegetarian&#34; or &#34;Palm oil free&#34;</p>

<p>Results are stored in the ingredients_analysis_tags array.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="validate_regular_expressions_(_)"
>validate_regular_expressions ( )</a></h2>

<p>This function is used to check that all regular expressions / parts of regular expressions used to parse ingredients are valid, without unmatched parenthesis etc.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="split_generic_name_from_ingredients_(_product_ref_language_code_)"
>split_generic_name_from_ingredients ( product_ref language_code )</a></h2>

<p>Some producers send us an ingredients list that starts with the generic name followed by the actual ingredients list.</p>

<p>e.g. &#34;P&#226;tes de fruits aromatis&#233;es &#224; la fraise et &#224; la canneberge, contenant de la maltodextrine et de l&#39;ac&#233;rola. Source de vitamines B1, B6, B12 et C. Ingr&#233;dients : Pulpe de fruits 50% (poire William 25%, fraise 15%, canneberge 10%), sucre, sirop de glucose de bl&#233;, maltodextrine 5%, stabilisant : glyc&#233;rol, g&#233;lifiant : pectine, acidifiant : acide citrique, ar&#244;me naturel de fraise, ar&#244;me naturel de canneberge, poudre d&#39;ac&#233;rola (ac&#233;rola, maltodextrine) 0,4%, vitamines : B1, B6 et B12. Fabriqu&#233; dans un atelier utilisant: GLUTEN*, FRUITS A COQUE*. * Allerg&#232;nes&#34;</p>

<p>This function splits the list to put the generic name in the generic_name_[lc] field and the ingredients list in the ingredients_text_[lc] field.</p>

<p>If there is already a generic name, it is not overridden.</p>

<p>WARNING: This function should be called only during the import of data from producers. It should not be called on lists that can be the result of an OCR, as there is no guarantee that the text before the ingredients list is the generic name. It should also not be called when we import product data from the producers platform to the public database.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="clean_ingredients_text_for_lang_(_product_ref_language_code_)"
>clean_ingredients_text_for_lang ( product_ref language_code )</a></h2>

<p>Perform some cleaning of the ingredients list.</p>

<p>The operations included in the cleaning must be 100% safe.</p>

<p>The function can be applied multiple times on the ingredients list.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="cut_ingredients_text_for_lang_(_product_ref_language_code_)"
>cut_ingredients_text_for_lang ( product_ref language_code )</a></h2>

<p>This function should be called once when getting text data from the OCR that includes an ingredients list.</p>

<p>It tries to remove phrases before and after the list that are not ingredients list.</p>

<p>It MUST NOT be applied multiple times on the ingredients list, as it could otherwise remove parts of the ingredients list. (e.g. it looks for &#34;Ingredients: &#34; and remove everything before it. If there are multiple &#34;Ingredients:&#34; listed, it would keep only the last one if called multiple times.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="replace_additive_($number,_$letter,_$variant)_-_normalize_the_additive"
>replace_additive ($number, $letter, $variant) - normalize the additive</a></h2>

<p>This function is used inside regular expressions to turn additives to a normalized form.</p>

<p>Using a function to concatenate the E-number, letter and variant makes it possible to deal with undefined $letter or $variant without triggering an undefined warning.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Synopsis"
>Synopsis</a></h3>

<pre>        $text =~ s/(\b)e( |-|\.)?$additivesregexp(\b|\s|,|\.|;|\/|-|\\|$)/replace_additive($3,$6,$9) . $12/ieg;</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'

>develop_ingredients_categories_and_types ( $product_lc, $text ) - turn &#34;oil (sunflower, olive and palm)&#34; into &#34;sunflower oil, olive oil, palm oil&#34;</a></h2>

<p>Some ingredients are specified by an ingredient &#34;category&#34; (e.g. &#34;oil&#34;, &#34;flavouring&#34;) and a &#34;type&#34; (e.g. &#34;sunflower&#34;, &#34;palm&#34; or &#34;strawberry&#34;, &#34;vanilla&#34;).</p>

<p>Sometimes, the category is mentioned only once for several types: &#34;strawberry and vanilla flavourings&#34;, &#34;vegetable oil (palm, sunflower)&#34;.</p>

<p>This function lists each individual ingredient: &#34;oil (sunflower, olive and palm)&#34; becomes &#34;sunflower oil, olive oil, palm oil&#34;</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Language"
>Language</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Ingredients_list_text"
>Ingredients list text</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Transformed_ingredients_list_text"
>Transformed ingredients list text</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="preparse_ingredients_text_($product_lc,_$text)_-_normalize_the_ingredient_list_to_make_parsing_easier"
>preparse_ingredients_text ($product_lc, $text) - normalize the ingredient list to make parsing easier</a></h2>

<p>This function transform the ingredients list in a more normalized list that is easier to parse.</p>

<p>It does the following:</p>

<p>- Normalize quote characters - Replace abbreviations by their full name - Remove extra spaces in compound words width dashes (e.g. c&#233;l&#233;ri - rave -&#62; c&#233;l&#233;ri-rave) - Split vitamins enumerations - Normalize additives and split additives enumerations - Split other enumerations (e.g. oils, some minerals) - Split allergens and traces - Deal with signs like * to indicate labels (e.g. *: Organic)</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Language"
>Language</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Ingredients_list_text"
>Ingredients list text</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Transformed_ingredients_list_text"
>Transformed ingredients list text</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="detect_allergens_from_ingredients_(_$product_ref_)"
>detect_allergens_from_ingredients ( $product_ref )</a></h2>

<p>Detects allergens from the ingredients extracted from the ingredients text, using the &#34;allergens:en&#34; property associated to some ingredients in the ingredients taxonomy.</p>

<p>This functions needs to be run after the $product_ref-&#62;{ingredients} array is populated from the ingredients text.</p>

<p>It is called by detect_allergens_from_text(). Allergens are added to $product_ref-&#62;{&#34;allergens_from_ingredients&#34;} which is then used by detect_allergens_from_text() to populate the allergens_tags field.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="detect_allergens_from_text_(_$product_ref_)"
>detect_allergens_from_text ( $product_ref )</a></h2>

<p>This function: - combines all the ways we have to detect allergens in order to populate the allergens_tags and traces_tags fields. - creates the ingredients_text_with_allergens_[lc] fields with added HTML &#60;span class=&#34;allergen&#34;&#62; tags</p>

<p>Allergens are recognized in the following ways:</p>

<p>1. using the list of ingredients that have been recognized through ingredients analysis, by looking at the allergens:en property in the ingredients taxonomy. This is done with the function detect_allergens_from_ingredients()</p>

<p>2. when entered in ALL CAPS, or between underscores</p>

<p>3. when matching exact entries o synonyms of the allergens taxonomy</p>

<p>Allergens detected using 2. or 3. are marked with &#60;span class=&#34;allergen&#34;&#62;</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_fruits_(_$ingredients_ref_)"
>add_fruits ( $ingredients_ref )</a></h2>

<p>Recursive function to compute the % of fruits, vegetables, nuts and olive/walnut/rapeseed oil for Nutri-Score computation.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="estimate_nutriscore_fruits_vegetables_nuts_value_from_ingredients_(_product_ref_)"
>estimate_nutriscore_fruits_vegetables_nuts_value_from_ingredients ( product_ref )</a></h2>

<p>This function analyzes the ingredients to estimate the minimum percentage of fruits, vegetables, nuts, olive / walnut / rapeseed oil, so that we can compute the Nutri-Score fruit points if we don&#39;t have a value given by the manufacturer or estimated by users.</p>

<p>Results are stored in $product_ref-&#62;{nutriments}{&#34;fruits-vegetables-nuts-estimate-from-ingredients_100g&#34;} (and _serving)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_milk_(_$ingredients_ref_)"
>add_milk ( $ingredients_ref )</a></h2>

<p>Recursive function to compute the % of milk for Nutri-Score computation.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="estimate_milk_percent_from_ingredients_(_product_ref_)"
>estimate_milk_percent_from_ingredients ( product_ref )</a></h2>

<p>This function analyzes the ingredients to estimate the minimum percentage of milk in a product, in order to know if a dairy drink should be considered as a food (at least 80% of milk) or a beverage.</p>

<p>Return value: estimated % of milk.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="POD_ERRORS"
>POD ERRORS</a></h1>

<p>Hey! <b>The above document had some coding errors, which are explained below:</b></p>

<dl>
<dt><a name="Around_line_787:"
>Around line 787:</a></dt>

<dd>
<p>Non-ASCII character seen before =encoding in &#39;Fran&#231;aise,&#39;. Assuming UTF-8</p>
</dd>
</dl>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
